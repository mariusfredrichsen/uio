"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.convertToIso8601 = exports.convertFromIso8601 = void 0;
var _polyfill = require("@js-temporal/polyfill");
var _dhis2CalendarsMap = require("../constants/dhis2CalendarsMap");
var _extractDatePartsFromDateString = require("./extract-date-parts-from-date-string");
var _helpers = require("./helpers");
/**
 * converts from an iso8601 (gregorian) date to a specific calendar
 *
 * @param date string in the format yyyy-MM-dd
 * @param userCalendar the calendar to covert to
 * @returns an object representing the date
 *
 * NOTE: the returned object contains two properties year and eraYear
 * to be consistent with the default behaviour of Temporal. This only affects
 * ethiopic calendar in practice. When accessing year, consumers should be defensive
 * and do: `const yearToUse = result.eraYear ?? result.year` for example.
 *
 * @see https://github.com/tc39/ecma402/issues/534 for more details
 */
const convertFromIso8601 = (date, userCalendar) => {
  var _dhis2CalendarsMap$us;
  const calendar = (0, _helpers.getCustomCalendarIfExists)((_dhis2CalendarsMap$us = _dhis2CalendarsMap.dhis2CalendarsMap[userCalendar]) !== null && _dhis2CalendarsMap$us !== void 0 ? _dhis2CalendarsMap$us : userCalendar);
  const {
    eraYear,
    year,
    month,
    day
  } = _polyfill.Temporal.PlainDate.from(date).withCalendar(calendar);
  return {
    eraYear,
    year,
    month,
    day
  };
};

/**
 * converts from a specific calendar (i.e. ethiopic or nepali) to iso8601 (gregorian)
 *
 * @param date calendar date in the format yyyy-MM-dd
 * @param userCalendar the calendar to convert from
 * @returns an object representing the iso8601 date
 */
exports.convertFromIso8601 = convertFromIso8601;
const convertToIso8601 = (date, userCalendar) => {
  var _dhis2CalendarsMap$us2;
  const calendar = (0, _helpers.getCustomCalendarIfExists)((_dhis2CalendarsMap$us2 = _dhis2CalendarsMap.dhis2CalendarsMap[userCalendar]) !== null && _dhis2CalendarsMap$us2 !== void 0 ? _dhis2CalendarsMap$us2 : userCalendar);
  const dateParts = typeof date === 'string' ? (0, _extractDatePartsFromDateString.extractDatePartsFromDateString)(date) : date;

  // this is a workaround for the ethiopic calendar being in a different
  // era by default. There is a discussion on Temporal on which should be
  // considered the default era. For us, we need to manually set it to era1
  // https://github.com/js-temporal/temporal-polyfill/blob/8fd0dead40de7c31398f4d2d41e145466ca57a16/lib/calendar.ts#L2010
  if (calendar === 'ethiopic') {
    dateParts.eraYear = dateParts.year;
    dateParts.era = 'era1';
    delete dateParts.year;
  }
  dateParts.calendar = calendar;
  const {
    year,
    month,
    day
  } = _polyfill.Temporal.PlainDate.from(dateParts).withCalendar('iso8601');
  return {
    year,
    month,
    day
  };
};
exports.convertToIso8601 = convertToIso8601;